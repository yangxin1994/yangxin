<% content_for :head do %>
  <%= stylesheet_link_tag "pages/carnival/campaigns-bundle", :media => "all" %>
  <%= javascript_include_tag "pages/carnival/campaigns-bundle" %>
  <script type="text/javascript">
    $(function(){
      window.data = <%= raw (@obj).to_json %>;
      var pre_status = parseInt(window.data.pre_status,10);
      window.current_step = parseInt(window.data.step,10);

      //如果拿到票后刷新页面，直接进入第一个任务
      if( $.cookie('ticket') && window.current_step == 0){
        window.current_step = 1; 
      }

      //已经领取第一关的手机充值,再次进入页面的时候直接进入下一个场景
      if($.cookie('reward_1')){
        window.current_step = 2;
      }

      //第二关任务完成 再次来到页面,直接进入第三个任务场景
      if($.cookie('reward_2')){
        window.current_step = 3; 
      }
      

      // for test
      // pre_status = 32;
      // window.current_step = 0;
      // window.data.t2_status = [0,0,0,0,0];
      // window.data.t3_status = [1,1,1,1,0];

      if(window.data.t3_surveys.length == 4){
        window.data.t3_status.pop();
      }

      if (pre_status) {     
        if(pre_status == 2){// for reject
          //$.od.odPopup({withoutTitle:true,content: '您不在此次调研范围内!'});
        }else if(pre_status == 32){ // for finish
          // get ticket
          if(window.current_step){
            //每个小任务(及每个大任务)完成后的跳转页面
            setSection(window.current_step);
          }else{
            //预调研通过,通知领取门票,并进入下一个任务
            $.carnivalbox({
              width:460,
              title:'已获得门票',
              content:'',
              btnCont:'立即前往',
              aftershow:function(){
                $('.carnival-popup a.btn').live('click',function(){
                  $.fancybox.close();
                  openDoor();
                })
              }
            })
          }
        } 
      }

      //set full page
      function setFullPage() {
          $('.fullPage').fullpage({
              verticalCentered: true,
              slidesColor: ['#eff2c9', '#eff2c9', '#eff2c9', '#eff2c9'],
              loopTop: false,
              loopBottom: false,
              autoScrolling: true
          })
      }
    
      //up step
      function foraward(prev_bottom,target_bottom,top){
        $('.happy').animate({'bottom':target_bottom + 'px'},3000,function(){
          if(top < 0){//到达顶端
            setTimeout(function(){
              fallback();
            },1000)            
          }

        })
      }

      //down step
      function fallback(){
        $('.happy').animate({'bottom':'35px'},3000,function(){
          $.carnivalbox({
            width:460,
            title:'跳楼机关卡已完成',
            content:'系统会在问卷审核通过后将话费充值到您的手机',

            btnCont:'继续任务',
            beforeshow:function(){
              var text = '<form action=""><input type="radio" name="charg" checked="checked" value="a" />10元<input type="radio" name="charg" value="b" />50元<input type="radio" name="charg" value="c" />100元</form>'
              $('.carnival-popup p').after(text);
          
            },
            aftershow:function(){
              var sub_btn   = $('.carnival-popup a.btn');

              sub_btn.live('click',function(){
                if(!sub_btn.hasClass('disabled')){
                    var money =  $('.carnival-popup input:checked').val();
                    if(money == 'a'){
                      money = 10;
                    }else if (money == 'b'){
                      money = 50;
                    }else{
                      money = 100;
                    }
                    sub_btn.addClass('disabled');
                    sendAjax(0,null,money);
                }
              });
            }
          });         
        })
      }

      //set section
      function setSection(step){
        var step = parseInt(step,10);
        if(step == 1){
          $('.section.wheel').addClass('active').siblings().removeClass('active');
          setTaskDetail(step,$('.section.wheel'));
        }else if(step == 2){
          $('.section.stair').addClass('active').siblings().removeClass('active');
          setTaskDetail(step,$('.section.stair'));
        }else if(step == 3){
          $('.section.balloon').addClass('active').siblings().removeClass('active');
          setTaskDetail(step,$('.section.balloon'));
        }else{
          $('.section.reward').addClass('active').siblings().removeClass('active');
          setTaskDetail(step,$('.section.reward'));
        }
      }

      // open door
      function openDoor(){
        TaskOpen('wheel');// start the wheel section
        $('.door .left').animate({'left':'-175px'},3000,function(){})

        $('.door .right').animate({'right':'-148px'},3000,function(){
          $.fn.fullpage.moveSectionUp()// go to next section
          var d = new Date();
          $.cookie('ticket',d.getTime());
        })
        $.fn.fullpage.moveSectionUp();
        
      }

      // open task完成上一个任务后设置下一个任务
      function TaskOpen(flag){
        switch(flag){
        case 'wheel':
          setTaskOne();
          break;
        case 'stair':
          setTaskTwo();
          break;
        case 'balloon':
          setTaskThree();
          break;u
        case 'reward':
          setTaskFour();
          break;
        }
      }

      //设置第一个大任务
      function setTaskOne(){
        fireUpBackground($('.section.wheel'));
        $('.section.wheel a').each(function(k,v){
          var uri = '/s/' + window.data.t1_surveys[k];
          $(v).attr('href',uri).attr('id',window.data.t1_surveys[k]);
        })
      }

      //设置第二个大任务
      function setTaskTwo(){
        fireUpBackground($('.section.stair'));
        var survey_arr = window.data.t2_surveys.reverse(); 
        $('.section.stair a').each(function(k,v){
          var uri = '/s/' + survey_arr[k];
          $(v).attr('href',uri).parent().attr('id',survey_arr[k]);
        })
      }

      //设置第三个大任务
      function setTaskThree(){
        fireUpBackground($('.section.balloon'));
        $('.section.balloon a').each(function(k,v){
          if(window.data.t3_surveys[k]){
            var uri = '/s/' + window.data.t3_surveys[k];
            $(v).attr('href',uri).parent().attr('id',window.data.t3_surveys[k]);
          }else{
            //第三个大任务,如果小任务不足五个，移除多于的绳子和答题链接
            $(v).parent().remove();
            $($('.line-wrap .line')[k -1]).hide();
          }
        })
      }

      //设置抽奖
      function setTaskFour(){

      }

      //答题跳转回来用
      function setTaskDetail(step,content){
        fireUpBackground(content);
        switch(step){
        case 1:
          flagSurvey(step,window.data.t1_surveys,window.data.t1_status);
          break;
        case 2:
          flagSurvey(step,window.data.t2_surveys,window.data.t2_status);
          break;
        case 3:
          flagSurvey(step,window.data.t3_surveys,window.data.t3_status);
          break;
        default:
          break;
        }
      }

      //点亮不同场景的背景颜色
      function fireUpBackground(secContent){
        // do something
      }

      //标识某个问卷是否已经回答完毕
      function flagSurvey(step,survey_arr,status_arr){
        //for test
        switch(step){
        case 1:
          setTaskOne();
          break;
        case 2:
          setTaskTwo();
          break;
        case 3:
          setTaskThree();
          break;                    
        }

        setFlag(step,survey_arr,status_arr);

        if(step == 1){
          //摩天轮,如果该大任务的每个小任务都完成,则加载动画效果
          if($.inArray(0,status_arr) < 0 ){
            turnWheel();
            //弹出话费充值提示
            setTimeout(function(){

              $.carnivalbox({
                width:460,
                title:'摩天轮关卡已完成',
                content:'系统会在问卷审核通过后将<b>10元话费</b>充值到您的手机',
                btnCont:'继续任务',
                beforeshow:function(){
                  $('.carnival-popup p').after('<form action=""><input type="text" name="phone"/></form>')
          
                },
                aftershow:function(){
                  var phone_ipt = $('.carnival-popup form input');
                  var sub_btn   = $('.carnival-popup a.btn');
                  phone_ipt.live('focus',function(){
                    $(this).removeClass('error');
                    sub_btn.removeClass('disabled');
                  });
                  sub_btn.live('click',function(){
                    if(!sub_btn.hasClass('disabled')){
                      var phone = phone_ipt.val();
                      if($.regex.isMobile(phone)){
                        sub_btn.addClass('disabled');
                        phone_ipt.removeClass('error');
                        sub_btn.addClass('disabled');
                        sendAjax(3,phone);                   
                      }else{
                        phone_ipt.addClass('error');
                        sub_btn.removeClass('disabled');
                      }
                    }
                  });
                }
              })              
            },1000)
          }else{
            // 弹出气泡提示操作方法
          }
        }

        if(step == 3){
          //筐子点燃火焰
          makeFire();

          if($('.line-wrap.line:visible').length == 0){
            //所有绳子都已经剪断,气球飞扬
            flyBalloon();
          }

        }

      }

      //t_type 任务类型
      //mobile 手机号
      //数量
      function sendAjax(t_type,phone,num){
        var url = '/carnival/users/draw_lottery';
        $.post(url,
          {mobile: phone, 
           type: t_type, 
           amount: num
          },function(data){
            if(data.success){
              if(t_type == 3){
                var d = new Date();
                $.cookie('reward_1',d.getTime());
                TaskOpen('stair'); 
              }else if(t_type == 0){
                var d = new Date();
                $.cookie('reward_2',d.getTime());
                TaskOpen('balloon');                
              }
              
              $.fancybox.close();
              $.fn.fullpage.moveSectionUp()
            }else{
              var notic = $('.carnival-popup .notic');
              if(data.value.error_code == -2){
                notic.html( '<a href="/s/' + window.data.background_survey + '">请先点亮小太阳</a>' );
              }
              if(data.value.error_code == -3){
                if(t_type == 3){
                  notic.html('请回答完摩天轮关卡的所有答题')
                }else if(t_type == 0){
                  notic.html('请回答完跳楼机关卡的所有答题')
                }
                
                $('.carnival-popup .submit').text('马上完成')
                $('.carnival-popup .submit').unbind('click');
                $('.carnival-popup .submit').bind('click',function(){
                  $.fancybox.close();
                })
              }
              notic.show();
            }
          })
      }

      //转动摩天轮
      function turnWheel(){
        var wheel = $('.section.wheel');
        wheel.find('a').hide();
        wheel.find('span').show();
        flash = wheel.find('.ferris');
        flashWheel();
      }

      //给气球点火
      function makeFire(){
        var umbrella = $('.umbrella');
        umbrella.addClass('act');
        var basket = $('.basket');

        if(window.data.t3_status.indexOf(0) < 0){
          if(basket.hasClass('left')){
            basket.removeClass('left').addClass('right');
          }else{
            basket.removeClass('right').addClass('left');  
          }          
        }
        setTimeout(makeFire,300); 
      }

      // set Active
      function setFlag(step,survey_arr,status_arr){
        if(step == 2){
          //跳楼机答题有顺序,必须从底往上答题
          survey_arr = survey_arr.reverse();
          //跳楼机,先上升，停止上升后标识底部的survey 为 答完状态
          var move_to = status_arr.indexOf(0);
          var prev_bottom;
          var target_bottom;
          switch(move_to){
            case 0:
              prev_bottom = 35;
              target_bottom = 35;
              break;
            case 1:
              prev_bottom = 35;
              target_bottom = 95;
              break;
            case 2:
              prev_bottom = 95;
              target_bottom = 155;
              break;
            case 3:
              prev_bottom = 155;
              target_bottom = 215;
              break;
            case 4:
              prev_bottom = 215;
              target_bottom = 275;
              break;
            default:
              prev_bottom = 280;
              target_bottom = 322;
          }
        
          $('.happy').css('bottom',prev_bottom);

          
          tmp_status = status_arr.filter(function(ele){return ele > 0 })
          if(tmp_status.length > 0){
            $('.sbottom').addClass('act');
            $('.happy').addClass('act');
          }else{
            $('.sbottom').removeClass('act');
            $('.happy').removeClass('act');
          }

          foraward(prev_bottom,target_bottom,move_to);

          $.each(survey_arr,function(k,v){
            if(parseInt(status_arr[k]) > 0){
              $('#' + v).addClass('act');
            }else{
              if(k != 0){
                if( parseInt(status_arr[k -1]) == 0 ){
                  $('#' + v).children().attr('href','javascript:void(0);');
                }
              }
            }           
          })
        }else{
          $.each(survey_arr,function(k,v){
            if(parseInt(status_arr[k]) > 0){
              $('#' + v).addClass('act');
              if(step == 3){
                //热气球,如果某个小任务完成,删除绳子
                $($('.line-wrap .line')[k]).hide();
              }
            }
          })          
        }        
      }
      //摩天轮发光闪烁
      function flashWheel(wheel){
        var wheel = $('.section.wheel');
        flash = wheel.find('.ferris');
        if(flash.hasClass('flash')){
          flash.removeClass('flash');
        }else{
          flash.addClass('flash');  
        }
        setTimeout(flashWheel,300);        
      }

      function flyBalloon(){
        var bg  = parseInt($('.bg4').css('background-position-y'));
        var nbg = bg - 1 + '%'
        $('.bg4').css({'background-position-y': nbg});
        var grass_top = parseInt( $('.ball-line').css('top') );
        var ngrass_top = grass_top + 10 + 'px';
        $('.ball-line').css({'top':ngrass_top});

        if(nbg == '30%'){
          $('.ball-body').animate({'top':'-350px'},4000,function(){
            $('.ly-plate').fadeIn(4000,function(){})
          })
          return false;
        }
        setTimeout(flyBalloon,100)
      }


      setFullPage();
    });


  </script>
<% end %>


<div class='fullPage'>
  <div class='section balloon'>
    <div class='page bg4'>
      <div class="page-inner">
        <div class='ball-cont'>
          <div class='ball-body'>
            <div class='umbrella'></div>
            <div class='basket'>
              <!-- <div class='stack stack5'>
                <a href='javascript:void(0);'></a>
              </div> -->
            </div>
          </div>
          <div class='ball-line'>
            <div class='line-wrap'>
              <div class='line line-1'></div>
              <div class='line line-2'></div>
              <div class='line line-3'></div>
              <div class='line line-4'></div>
              <div class='bg-grass'></div>
              <div class="tooltip rqq">
                点击问号解开热气球绳子,<br>4根全部解开立即获得<b>神秘奖品</b><br>和<b>小米大奖抽奖机会！</b>
              </div>
              <div class='stack stack1'><a href='javascript:void(0);'></a></div>
              <div class='stack stack2'><a href='javascript:void(0);'></a></div>
              <div class='stack stack3'><a href='javascript:void(0);'></a></div>
              <div class='stack stack4'><a href='javascript:void(0);'></a></div>
            </div>
          </div>
        </div>
        <div class="ly-plate">
          <div class="rotate-bg"></div>
            <div class="lottery-star">
              <img src="/assets/activities/2014-6/ferris/rotate-static.png" id="lotteryBtn">
            </div>
        </div>
      </div>
    </div>
  </div>
  <div class='section stair'>
    <div class='page bg3'>
      <div class="page-inner">
        <div id='machine-wrap'>
          <div class='wrap-skin'>
            <div class="tooltip tlj">
              点击跳楼机问号进行闯关,<br>本关分5个小任务,闯关成功<br>可参加<b>神秘抽奖哦！</b>
            </div>
            <div class='happy'></div>
            <div class='st5'><a href='javascript:void(0);'></a></div>
            <div class='st4'><a href='javascript:void(0);'></a></div>
            <div class='st3'><a href='javascript:void(0);'></a></div>
            <div class='st2'><a href='javascript:void(0);'></a></div>
            <div class='st1'><a href='javascript:void(0);'></a></div>
            <div class='sbottom'></div>            
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class='section wheel'>
    <div class="page bg2">
      <div class="page-inner">
        <div id="ferris-wheel">
          <div class="tooltip mtl">
            <!-- <div style='font-size: 50px; color: #f00;'>?</div> -->
            点击摩天轮问号进行闯关,<br> 本关分5个小任务,闯关成功即送<b>10元手机充值卡！</b>
          </div>
          <span class="ferris-wheel-box">
          <a href="javascript:void(0);" class="one"></a>
          <a href="javascript:void(0);" class="two"></a>
          <a href="javascript:void(0);" class="three"></a>
          <a href="javascript:void(0);" class="four"></a>
          <a href="javascript:void(0);" class="five"></a>
          <span class="ferris"></span>
          <span class="holder"></span>
          </span>
        </div>        
      </div>
    </div>
  </div>
  <div class='section gate active'>
    <div class="page bg1">
      <div class="page-inner">
        <div class="door-box">
          <div class="door">
            <a href="javascript:void(0);" class="start">立即开始</a>
            <p class="last">如果您已参加过本活动，可 <a href="javascript:void(0);">继续游戏</a></p>
          <span class="left"></span>
          <span class="right"></span>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
